---
import '../../styles.css';
import crypto from 'crypto';
const nonce = crypto.randomBytes(16).toString('base64');
const allowUnsafeStyles = process.env.NODE_ENV !== 'production';
const styleDirective = allowUnsafeStyles ? "'unsafe-inline'" : `'nonce-${nonce}'`;
const csp = `default-src 'self'; script-src 'self' 'nonce-${nonce}'; style-src 'self' ${styleDirective}; img-src 'self' data:; connect-src 'self';`;
---
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard — Smart Attendance</title>
    <meta http-equiv="Content-Security-Policy" content={csp} />
  </head>
  <body class="bg-dark">
    <main class="container card">
      <h2 class="accent">Admin Dashboard</h2>
      <div class="row">
        <div>
          <label for="date">Upload attendance CSV for a date</label>
          <input id="date" type="date" />
          <input id="csvfile" type="file" accept=".csv" />
          <button id="uploadBtn" class="btn">Upload CSV</button>
        </div>
        <div>
          <button id="downloadBtn" class="btn ghost">Download CSV</button>
          <button id="logoutBtn" class="btn danger">Logout</button>
        </div>
      </div>

      <h3>Attendance</h3>
      <div class="row toolbar">
        <label>Limit</label>
        <input id="limit" type="number" min="1" max="5000" value="100" class="small-input" />
        <label>Offset</label>
        <input id="offset" type="number" min="0" value="0" class="small-input" />
        <button id="prevBtn" class="btn ghost">Prev</button>
        <button id="nextBtn" class="btn ghost">Next</button>
        <div id="pageInfo" class="muted"></div>
      </div>

      <div id="uploadStatus" class="muted status"></div>

      <table id="table" class="table">
        <thead><tr><th>Name</th><th>ID</th><th>Date</th><th>Status</th></tr></thead>
        <tbody></tbody>
      </table>
    </main>

    <script type="module" nonce={nonce}>
      // Dashboard client with pagination and upload result reporting
      const uploadBtn = document.getElementById('uploadBtn');
      const csvfile = document.getElementById('csvfile');
      const dateInput = document.getElementById('date');
      const tableBody = document.querySelector('#table tbody');
      const downloadBtn = document.getElementById('downloadBtn');
      const logoutBtn = document.getElementById('logoutBtn');
      const limitInput = document.getElementById('limit');
      const offsetInput = document.getElementById('offset');
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const pageInfo = document.getElementById('pageInfo');
      const uploadStatus = document.getElementById('uploadStatus');

      let totalItems = 0;

      function render(rows){
        tableBody.innerHTML = '';
        for(const r of rows){
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${escapeHtml(r.name||'')}</td><td>${escapeHtml(r.id||'')}</td><td>${escapeHtml(r.date||'')}</td><td>${escapeHtml(r.status||'')}</td>`;
          tableBody.appendChild(tr);
        }
      }

      function escapeHtml(s){
        return String(s).replace(/[&<>\"]/g, (c)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c]));
      }

      async function fetchAttendance(){
        const limit = Number(limitInput.value) || 100;
        const offset = Number(offsetInput.value) || 0;
        const resp = await fetch(`/api/attendance?limit=${limit}&offset=${offset}`, { credentials: 'same-origin' });
        if(resp.ok){
          const json = await resp.json();
          totalItems = json.total || 0;
          render(json.data || []);
          pageInfo.textContent = `Showing ${json.count} of ${totalItems} (offset ${json.offset}, limit ${json.limit})`;
        } else if (resp.status === 401){
          location.href = '/admin/login';
        } else {
          console.error('Failed to load attendance', resp.status);
        }
      }

      // Simple CSV parser for demo: assumes header with name,id
      function parseCSV(text){
        const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
        if(lines.length<1) return [];
        const headers = lines[0].split(',').map(h=>h.trim().toLowerCase());
        const out = [];
        for(let i=1;i<lines.length;i++){
          const cols = lines[i].split(',');
          const obj = {};
          headers.forEach((h,idx)=> obj[h]=cols[idx]?.trim());
          out.push(obj);
        }
        return out;
      }

      uploadBtn?.addEventListener('click', async ()=>{
        uploadStatus.textContent = '';
        if(!csvfile.files?.length){ uploadStatus.textContent = 'Select CSV file'; return; }
        const f = csvfile.files[0];
        const text = await f.text();
        const rows = parseCSV(text);
        const date = dateInput.value || new Date().toISOString().slice(0,10);
        const payload = rows.map(r=>({ name: r.name||r.fullname||'', id: r.id||r.studentid||'', date, status: 'present' }));
        const res = await fetch('/api/uploadCSV', { method: 'POST', credentials: 'same-origin', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ rows: payload }) });
        try{
          const j = await res.json();
          if(res.ok){
            uploadStatus.textContent = `Uploaded — appended ${j.appended || 0} rows.`;
            // reload first page
            offsetInput.value = 0;
            fetchAttendance();
          } else if(res.status === 401){
            location.href = '/admin/login';
          } else {
            uploadStatus.textContent = j?.message || 'Upload failed';
          }
        } catch(e){
          uploadStatus.textContent = res.ok ? 'Upload done' : 'Upload failed';
        }
      });

      downloadBtn?.addEventListener('click', async ()=>{
        const limit = Number(limitInput.value) || 100;
        const offset = Number(offsetInput.value) || 0;
        const res = await fetch(`/api/attendance?format=csv&limit=${limit}&offset=${offset}`, { credentials: 'same-origin' });
        if(res.ok){
          const txt = await res.text();
          const blob = new Blob([txt], { type: 'text/csv' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url; a.download = 'attendance.csv';
          a.click();
          URL.revokeObjectURL(url);
        } else if(res.status === 401){
          location.href = '/admin/login';
        } else alert('Failed to download');
      });

      prevBtn?.addEventListener('click', ()=>{
        const limit = Number(limitInput.value) || 100;
        let offset = Number(offsetInput.value) || 0;
        offset = Math.max(0, offset - limit);
        offsetInput.value = offset;
        fetchAttendance();
      });

      nextBtn?.addEventListener('click', ()=>{
        const limit = Number(limitInput.value) || 100;
        let offset = Number(offsetInput.value) || 0;
        offset = offset + limit;
        if(offset >= totalItems) return;
        offsetInput.value = offset;
        fetchAttendance();
      });

      logoutBtn?.addEventListener('click', async ()=>{
        await fetch('/api/logout', { method: 'POST', credentials: 'same-origin' });
        location.href = '/admin/login';
      });

      // Initial load
      fetchAttendance();
    </script>
  </body>
</html>
