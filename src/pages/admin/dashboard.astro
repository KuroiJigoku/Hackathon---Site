---
import '../../styles.css';
import crypto from 'crypto';
const nonce = crypto.randomBytes(16).toString('base64');
const allowUnsafeStyles = process.env.NODE_ENV !== 'production';
const styleDirective = allowUnsafeStyles ? "'unsafe-inline'" : `'nonce-${nonce}'`;
const csp = `default-src 'self'; script-src 'self' 'nonce-${nonce}'; style-src 'self' https://fonts.googleapis.com ${styleDirective}; font-src 'self' https://fonts.gstatic.com; img-src 'self' data:; connect-src 'self';`;
---
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard — Smart Attendance</title>
    <meta http-equiv="Content-Security-Policy" content={csp} />
    <link href="https://fonts.googleapis.com/css2?family=Material+Icons" rel="stylesheet" />
  </head>
  <body class="bg-dark centered-viewport">
    <main class="container md-card fade-in">
      <header class="appbar">
        <div class="title">Smart Attendance — Admin</div>
        <div class="md-actions">
            <button id="syncBtn" class="md-btn ripple" title="Sync with remote API">
            <span class="material-icons">sync</span>
            <span>Sync Now</span>
            </button>
            <button id="logoutBtn" class="md-btn ripple" title="Logout">
            <span class="material-icons">logout</span>
            </button>
        </div>
        </header>

        <section class="dashboard-header" style="padding:16px; display:flex; justify-content:space-between; align-items:center;">
        <div>
            <h2 class="accent" style="margin:0">Attendance Logs</h2>
            <div id="lastImport" class="muted" style="font-size:0.85em; margin-top:4px;">
            <span class="material-icons" style="font-size:14px; vertical-align:middle;">history</span>
            Last Sync: <span id="syncTimestamp">N/A</span>
            </div>
        </div>
        <div id="syncStatus" class="badge" style="display:none; background:rgba(255,59,59,0.1); font-size:12px;">Syncing...</div>
        </section>
    <h3 style="margin:12px 16px 6px;color:var(--md-on-surface)">Attendance</h3>
      <div class="row toolbar" style="padding:0 16px 12px 16px">
        <label>Limit</label>
        <input id="limit" type="number" min="1" max="5000" value="100" class="md-input small-input" />
        <label>Offset</label>
        <input id="offset" type="number" min="0" value="0" class="md-input small-input" />
        <button id="prevBtn" class="md-btn">Prev</button>
        <button id="nextBtn" class="md-btn">Next</button>
        <div id="pageInfo" class="muted"></div>
      </div>

      <div id="uploadStatus" class="muted status" style="padding:0 16px"></div>

      <div style="padding:0 16px 18px 16px">
        <table id="table" class="table md-card" style="width:100%">
          <thead><tr><th>Name</th><th>ID</th><th>Date</th><th>Period</th><th>Time</th><th>Status</th><th>Actions</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </main>


    <script type="module" nonce={nonce}>
      // Dashboard client with pagination and upload result reporting
      const tableBody = document.querySelector('#table tbody');
      const logoutBtn = document.getElementById('logoutBtn');
      const limitInput = document.getElementById('limit');
      const offsetInput = document.getElementById('offset');
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const pageInfo = document.getElementById('pageInfo');
      const syncBtn = document.getElementById('syncBtn');
      const syncTimestamp = document.getElementById('syncTimestamp');
      const syncStatus = document.getElementById('syncStatus');

      let totalItems = 0;

      function showToast(msg, timeout=3000){
        let sb = document.getElementById('snackbar');
        if(!sb){ sb = document.createElement('div'); sb.id='snackbar'; sb.className='snackbar'; document.body.appendChild(sb); }
        sb.textContent = msg;
        sb.classList.add('show');
        setTimeout(()=> sb.classList.remove('show'), timeout);
      }

      // modal helper
      function openEditModal(data, onSave){
        // backdrop
        const backdrop = document.createElement('div'); backdrop.className='modal-backdrop';
        const modal = document.createElement('div'); modal.className='modal';
        modal.innerHTML = `
          <h3>Edit Attendance</h3>
          <label>Name</label>
          <input id="modal-name" class="md-input" value="${(data.name||'').replace(/"/g,'&quot;')}" />
          <label>Status</label>
          <select id="modal-status" class="md-input"><option value="present">present</option><option value="absent">absent</option><option value="late">late</option></select>
          <div class="modal-actions"><button id="modal-cancel" class="md-btn">Cancel</button><button id="modal-save" class="md-btn primary">Save</button></div>
        `;
        backdrop.appendChild(modal);
        document.body.appendChild(backdrop);
        const sel = modal.querySelector('#modal-status'); sel.value = data.status || 'present';
        modal.querySelector('#modal-cancel').addEventListener('click', ()=>{ backdrop.remove(); });
        modal.querySelector('#modal-save').addEventListener('click', async ()=>{
          const name = modal.querySelector('#modal-name').value.trim();
          const status = modal.querySelector('#modal-status').value;
          try{ await onSave({ ...data, name, status }); backdrop.remove(); showToast('Saved'); } catch(e){ showToast('Save failed'); }
        });
        // trap focus (simple)
        modal.querySelector('#modal-name').focus();
      }

      function statusBadge(s){
        const st = String(s||'').toLowerCase();
        if(st === 'present' || st === 'p' || st === 'present') return `<span class="badge" style="background:rgba(0,200,50,0.08);color:#9aff9a">${escapeHtml(s||'present')}</span>`;
        if(st === 'absent' || st === 'a' || st === 'absent') return `<span class="badge" style="background:rgba(200,30,30,0.08);color:#ff8b8b">${escapeHtml(s||'absent')}</span>`;
        if(st === 'late') return `<span class="badge" style="background:rgba(200,150,30,0.06);color:#ffd97a">${escapeHtml(s)}</span>`;
        return `<span class="badge" style="background:rgba(255,255,255,0.02);color:var(--muted)">${escapeHtml(s||'')}</span>`;
      }

      function render(rows){
        tableBody.innerHTML = '';
        for(const r of rows){
          const tr = document.createElement('tr');
          tr.classList.add('slide-up');
          const name = escapeHtml(r.name||'');
          const edited = r.edited ? true : false;
          const sid = escapeHtml(r.id||'');
          const date = escapeHtml(r.date||'');
          const period = escapeHtml(r.period||'');
          const time = escapeHtml(r.time||'');
          const status = escapeHtml(r.status||'');
          tr.innerHTML = `<td>${name} ${edited?'<span class="badge" style="background:rgba(255,200,0,0.06);color:#ffd97a;margin-left:8px;font-size:11px">edited</span>':''}</td><td>${sid}</td><td>${date}</td><td>${period}</td><td>${time}</td><td class="status-cell">${statusBadge(status)}</td><td class="actions-cell"></td>`;
          const actionsCell = tr.querySelector('.actions-cell');
          
          const editBtn = document.createElement('button');
          editBtn.className = 'md-btn ripple';
          editBtn.innerHTML = `<span class="material-icons">edit</span>`;
          editBtn.title = 'Edit status';
          
          editBtn.addEventListener('click', () => {
            openEditModal(r, async (payload) => {
              const statusCell = tr.querySelector('.status-cell');
              const prev = statusCell.textContent;
              statusCell.textContent = payload.status;

              // Send the full identity (id, date, period)
              const res = await fetch('/api/attendance_edit.json', { 
                method: 'POST', 
                credentials: 'same-origin', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({ 
                  id: payload.id, 
                  date: payload.date, 
                  period: payload.period, // CRITICAL: This prevents duplicates
                  status: payload.status, 
                  name: payload.name 
                  // Note: We don't send 'time' here so the backend can preserve the original
                }) 
              });

              if (!res.ok) { 
                statusCell.textContent = prev; 
                const j = await res.json().catch(() => null); 
                showToast(j?.message || 'Failed to update'); 
              }
            });
          });
          actionsCell.appendChild(editBtn);
          tableBody.appendChild(tr);
        }
      }

      function escapeHtml(s){
        return String(s).replace(/[&<>\"]/g, (c)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c]));
      }

      async function fetchAttendance(){
        const limit = Number(limitInput.value) || 100;
        const offset = Number(offsetInput.value) || 0;
        const resp = await fetch(`/api/attendance.json?limit=${limit}&offset=${offset}`, { credentials: 'same-origin' });
        if(resp.ok){
          const json = await resp.json();
          totalItems = json.total || 0;
          render(json.data || []);
          pageInfo.textContent = `Showing ${json.count} of ${totalItems} (offset ${json.offset}, limit ${json.limit})`;
        } else if (resp.status === 401){
          location.href = '/admin/login';
        } else {
          console.error('Failed to load attendance', resp.status);
        }
      }

      // New function to trigger manual remote fetch
      async function triggerManualSync() {
        syncBtn.disabled = true;
        syncStatus.style.display = 'inline-block';
        syncStatus.textContent = 'Syncing...';
        
        try {
          // Calling your existing remote import API
          const res = await fetch('/api/import_remote.json', { method: 'GET', credentials: 'same-origin' });
          const data = await res.json();
          
          if (res.ok) {
            showToast(`Sync successful: Imported ${data.imported} records`);
            await fetchAttendance(); // Refresh table immediately
            updateLastSyncLabel();
          } else {
            showToast('Sync failed: ' + (data.message || 'Unknown error'));
          }
        } catch (e) {
          showToast('Network error during sync');
        } finally {
          syncBtn.disabled = false;
          syncStatus.style.display = 'none';
        }
      }

      // Fetch the last import state from the server state helper
      async function updateLastSyncLabel() {
        try {
          const res = await fetch('/api/import_status.json');
          if (res.ok) {
            const status = await res.json();
            if (status.at) {
              const date = new Date(status.at);
              syncTimestamp.textContent = date.toLocaleTimeString() + ' ' + date.toLocaleDateString();
            }
          }
        } catch (e) { console.warn('Could not fetch sync status'); }
      }

      // Attach event listener
      syncBtn?.addEventListener('click', triggerManualSync);

      // Initial calls
      fetchAttendance();
      updateLastSyncLabel();
      
      // Refresh label and data every 20s
      setInterval(() => {
        fetchAttendance();
        updateLastSyncLabel();
      }, 20000);
    

      prevBtn?.addEventListener('click', ()=>{
        const limit = Number(limitInput.value) || 100;
        let offset = Number(offsetInput.value) || 0;
        offset = Math.max(0, offset - limit);
        offsetInput.value = offset;
        fetchAttendance();
      });

      nextBtn?.addEventListener('click', ()=>{
        const limit = Number(limitInput.value) || 100;
        let offset = Number(offsetInput.value) || 0;
        offset = offset + limit;
        if(offset >= totalItems) return;
        offsetInput.value = offset;
        fetchAttendance();
      });

      logoutBtn?.addEventListener('click', async ()=>{
        await fetch('/api/logout.json', { method: 'POST', credentials: 'same-origin' });
        location.href = '/admin/login';
      });

      // Initial load
      fetchAttendance();
    </script>
  </body>
</html>
